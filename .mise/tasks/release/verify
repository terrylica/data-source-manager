#!/usr/bin/env bash
#MISE description="Phase 4: Verify release artifacts"
#MISE depends=["release:version"]
set -euo pipefail

echo "=== Verifying Release ==="

# Get version from pyproject.toml
VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
echo "Version: $VERSION"

# Check 1: Git tag exists
if git rev-parse "v$VERSION" &>/dev/null; then
    echo "✓ Tag v$VERSION exists"
else
    echo "✗ Tag v$VERSION not found"
    exit 1
fi

# Check 2: GitHub release exists (using curl, NOT gh CLI - avoids process storms)
# See: ~/.claude/CLAUDE.md for process storm prevention policy
REPO_URL="https://api.github.com/repos/terrylica/data-source-manager/releases/tags/v$VERSION"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    -H "Authorization: token ${GH_TOKEN:-$GITHUB_TOKEN}" \
    -H "Accept: application/vnd.github.v3+json" \
    "$REPO_URL" 2>/dev/null || echo "000")

if [[ "$HTTP_STATUS" == "200" ]]; then
    echo "✓ GitHub release v$VERSION exists"
elif [[ "$HTTP_STATUS" == "404" ]]; then
    echo "✗ GitHub release v$VERSION not found"
    exit 1
else
    echo "⚠ Could not verify GitHub release (HTTP $HTTP_STATUS)"
    echo "  Check manually: https://github.com/terrylica/data-source-manager/releases/tag/v$VERSION"
fi

# Check 3: CHANGELOG updated
if grep -q "## \[$VERSION\]" CHANGELOG.md 2>/dev/null || grep -q "# $VERSION" CHANGELOG.md 2>/dev/null; then
    echo "✓ CHANGELOG.md updated"
else
    echo "⚠ CHANGELOG.md may not contain $VERSION entry"
fi

echo ""
echo "✓ Release v$VERSION verified"
