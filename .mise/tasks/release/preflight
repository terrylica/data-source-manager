#!/usr/bin/env bash
#MISE description="Phase 1: Validate prerequisites"
set -euo pipefail

echo "=== Release Preflight ==="

# Check 1: Working directory clean
git update-index --refresh -q || true
if [[ -n "$(git status --porcelain)" ]]; then
    echo "✗ Working directory not clean"
    git status --short
    exit 1
fi
echo "✓ Working directory clean"

# Check 2: GitHub authentication (token exists)
if [[ -z "${GH_TOKEN:-}" ]] || [[ -z "$(echo "$GH_TOKEN" | tr -d '[:space:]')" ]]; then
    echo "✗ GH_TOKEN not set or empty"
    echo "  Run: eval \"\$(mise env)\" or check .mise.local.toml"
    exit 1
fi
echo "✓ GH_TOKEN configured"

# Check 3: GitHub token format validation (no gh CLI - avoids process storms)
# Valid formats: ghp_* (classic PAT) or github_pat_* (fine-grained PAT)
if [[ ! "$GH_TOKEN" =~ ^ghp_[a-zA-Z0-9]{36}$ ]] && [[ ! "$GH_TOKEN" =~ ^github_pat_ ]]; then
    echo "⚠ GH_TOKEN format may be invalid (expected ghp_* or github_pat_*)"
    echo "  Token starts with: ${GH_TOKEN:0:10}..."
    # Don't exit - let it try anyway
fi
echo "✓ GH_TOKEN format validated"

# Check 4: Node.js available
if ! command -v node &>/dev/null; then
    echo "✗ Node.js not available"
    echo "  Run: mise install"
    exit 1
fi
echo "✓ Node.js $(node --version) available"

# Check 5: semantic-release installed
if [[ ! -d "node_modules/semantic-release" ]]; then
    echo "✗ semantic-release not installed"
    echo "  Run: npm install"
    exit 1
fi
echo "✓ semantic-release installed"

# Check 6: Releasable commits exist
LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
if [[ -n "$LATEST_TAG" ]]; then
    COMMITS=$(git log "$LATEST_TAG"..HEAD --oneline 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$COMMITS" -eq 0 ]]; then
        echo "✗ No commits since $LATEST_TAG"
        exit 1
    fi
    echo "✓ $COMMITS commits since $LATEST_TAG"
else
    echo "✓ No previous tags (initial release)"
fi

# Check 7: Python version (enforce 3.13)
PYTHON_VERSION=$(python --version 2>&1 | grep -oE '[0-9]+\.[0-9]+')
if [[ "$PYTHON_VERSION" != "3.13" ]]; then
    echo "⚠ Python version is $PYTHON_VERSION (expected 3.13)"
fi
echo "✓ Python $PYTHON_VERSION detected"

echo ""
echo "✓ All preflight checks passed"
