# mise configuration for data-source-manager
# See: https://mise.jdx.dev/
#
# IMPORTANT: Python 3.13 ONLY - never change this version
# Environment variables are loaded from .mise.local.toml (git-ignored)
# Create .mise.local.toml from .mise.local.toml.example for local development

[tools]
python = "3.13"  # CRITICAL: Do not change - project requires Python 3.13 exactly
node = "25"      # Required for semantic-release

# Automatic virtualenv activation
[settings]
experimental = true

[env]
_.python.venv = { path = ".venv", create = true }

#
# === TEST TASKS ===
#

[tasks.test]
description = "Run unit tests"
run = "uv run -p 3.13 pytest tests/unit/ -v"

[tasks."test:all"]
description = "Run all tests"
run = "uv run -p 3.13 pytest tests/ -v"

[tasks."test:integration"]
description = "Run integration tests (requires network)"
run = "uv run -p 3.13 pytest tests/integration/ -v"

[tasks."test:okx"]
description = "Run OKX API tests"
run = "uv run -p 3.13 pytest tests/okx/ -m okx -v"

[tasks."test:coverage"]
description = "Run tests with coverage report"
run = "uv run -p 3.13 pytest --cov=src/data_source_manager --cov-report=html --cov-report=term-missing tests/unit/"
outputs = ["htmlcov/"]

#
# === CODE QUALITY TASKS ===
#

[tasks.lint]
description = "Run ruff linter with auto-fix"
run = "uv run -p 3.13 ruff check --fix ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks.format]
description = "Format code with ruff"
run = "uv run -p 3.13 ruff format ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks.typecheck]
description = "Run type checking with pyright"
run = "uv run -p 3.13 pyright src/"
sources = ["src/**/*.py"]

[tasks."check:all"]
description = "Run all checks (lint, format, typecheck) in parallel"
depends = ["lint", "format", "typecheck"]

#
# === DOCUMENTATION TASKS ===
#

[tasks."docs:links"]
description = "Check documentation links (offline mode)"
run = "lychee --offline --root-dir . ."
sources = ["**/*.md"]

[tasks."docs:check"]
description = "Run all documentation checks"
depends = ["docs:links"]

#
# === BUILD TASKS ===
#

[tasks.build]
description = "Build package distribution"
run = "uv build"
sources = ["src/**/*.py", "pyproject.toml"]
outputs = ["dist/"]

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf dist/ build/ *.egg-info src/*.egg-info htmlcov/ .coverage"

#
# === DEVELOPMENT TASKS ===
#

[tasks.install]
description = "Install package in development mode with all dependencies"
run = "uv pip install -e '.[dev]'"

[tasks.sync]
description = "Sync dependencies using uv"
run = "uv sync --dev"

[tasks.verify]
description = "Verify package imports correctly"
run = "uv run -p 3.13 python -c 'from data_source_manager import DataSourceManager; print(\"✓ Import OK\")'"

[tasks."cache:clear"]
description = "Clear cache directory (prompts for confirmation)"
run = "uv run -p 3.13 python scripts/dev/clear_cache.py clear -d ~/.cache/data_source_manager"

[tasks."cache:clear-force"]
description = "Clear cache directory without confirmation"
run = "uv run -p 3.13 python scripts/dev/clear_cache.py clear -d ~/.cache/data_source_manager -y"

[tasks."cache:status"]
description = "Show cache directory status"
run = "du -sh ~/.cache/data_source_manager 2>/dev/null || echo 'Cache directory not found'"

[tasks."cache:health"]
description = "Check cache health and statistics"
run = "uv run -p 3.13 python docs/skills/dsm-fcp-monitor/scripts/cache_health.py --verbose"

#
# === FCP DIAGNOSTICS TASKS ===
#

[tasks."fcp:diagnose"]
description = "Diagnose FCP behavior for BTCUSDT (default)"
run = "uv run -p 3.13 python docs/skills/dsm-usage/scripts/diagnose_fcp.py BTCUSDT futures_usdt 1h --days 3"

[tasks."fcp:validate"]
description = "Validate symbol format for market type"
run = """
echo "Usage: mise run fcp:validate -- SYMBOL MARKET_TYPE"
echo "Example: mise run fcp:validate -- BTCUSDT FUTURES_USDT"
echo ""
echo "Valid market types: SPOT, FUTURES_USDT, FUTURES_COIN"
"""

#
# === CLAUDE CODE INFRASTRUCTURE TASKS ===
#

[tasks."claude:validate"]
description = "Validate Claude Code infrastructure setup"
run = "uv run -p 3.13 python docs/skills/dsm-usage/scripts/validate_infrastructure.py"
sources = [".claude/**/*.md", "docs/skills/*/SKILL.md", "CLAUDE.md"]

#
# === QUICK CHECK TASKS ===
#

[tasks.quick]
description = "Quick validation (lint + unit tests + import)"
run = """
echo "=== Quick Validation ==="
echo ""
echo "1. Lint check..."
uv run -p 3.13 ruff check . --quiet
echo "   ✓ Lint passed"
echo ""
echo "2. Unit tests..."
uv run -p 3.13 pytest tests/unit/ -q --tb=no
echo ""
echo "3. Import check..."
uv run -p 3.13 python -c 'from data_source_manager import DataSourceManager; print("   ✓ Import OK")'
echo ""
echo "=== All checks passed ==="
"""

#
# === HELP TASK ===
#

[tasks.help]
description = "Show available tasks"
run = """
echo "=== Data Source Manager Tasks ==="
echo ""
echo "Testing:"
echo "  mise run test           # Unit tests"
echo "  mise run test:all       # All tests"
echo "  mise run test:coverage  # Unit tests with coverage"
echo "  mise run test:okx       # OKX integration tests"
echo ""
echo "Code Quality:"
echo "  mise run lint           # Ruff linter with auto-fix"
echo "  mise run format         # Ruff formatter"
echo "  mise run typecheck      # Pyright type checking"
echo "  mise run check:all      # All checks (parallel)"
echo ""
echo "Documentation:"
echo "  mise run docs:links     # Check markdown links"
echo "  mise run docs:check     # All doc checks"
echo ""
echo "Build & Install:"
echo "  mise run build          # Build distribution"
echo "  mise run install        # Install in dev mode"
echo "  mise run sync           # Sync dependencies"
echo "  mise run clean          # Clean artifacts"
echo "  mise run verify         # Verify imports"
echo ""
echo "Cache Management:"
echo "  mise run cache:status   # Show cache size"
echo "  mise run cache:health   # Check cache health"
echo "  mise run cache:clear    # Clear cache (prompts)"
echo "  mise run cache:clear-force  # Clear without prompts"
echo ""
echo "FCP Diagnostics:"
echo "  mise run fcp:diagnose   # Diagnose FCP for BTCUSDT"
echo "  mise run fcp:validate   # Validate symbol format"
echo ""
echo "Quick Checks:"
echo "  mise run quick          # Quick validation (lint+test+import)"
echo ""
echo "Claude Code Infrastructure:"
echo "  mise run claude:validate  # Validate Claude Code setup"
echo ""
echo "Release (see .mise/tasks/release/):
echo "  mise run release:preflight  # Validate prerequisites"
echo "  mise run release:dry        # Dry run"
echo "  mise run release:full       # Full release"
"""

# Release tasks are in .mise/tasks/release/ directory
# Run: mise run release:preflight, release:dry, release:full
